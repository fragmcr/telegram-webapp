<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ü–ú–† (–õ–æ–∫–∞–ª—å–Ω–∞—è –í–µ—Ä—Å–∏—è)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–∑—É–Ω–∫–∞ (Scrollbar) –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (drag scrolling) */
        .hide-scrollbar::-webkit-scrollbar {
            height: 0px; /* –î–ª—è Chrome, Safari –∏ Opera */
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* –î–ª—è IE –∏ Edge */
            scrollbar-width: none;  /* –î–ª—è Firefox */
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-out { animation: fadeOut 0.3s ease-in forwards; }
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .cursor-grabbing {
            cursor: grabbing !important;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (–≠—Ñ—Ñ–µ–∫—Ç "–≤—ã–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è" –∏ –≤—Ä–∞—â–µ–Ω–∏—è) --- */
        @keyframes rotateIn {
            0% { transform: scale(0.01) rotate(-30deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes rotateOut {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(0.01) rotate(30deg); opacity: 0; }
        }

        .animate-in-ach { 
            animation: rotateIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; 
        }
        .animate-out-ach { 
            animation: rotateOut 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md p-6 rounded-xl shadow-2xl transition-colors duration-500">
        <h1 id="main-title" class="text-3xl font-bold mb-6 text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        <div id="content" class="text-center">
            </div>
        
        <button id="profile-btn" class="absolute top-4 right-4 p-1 rounded-full bg-white text-gray-800 shadow-lg hidden 
                                       transition transform duration-200 hover:scale-110 active:scale-90" 
                onclick="renderProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>
        </button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-900 dark:text-white">–°–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <p id="modal-message" class="mb-6 text-gray-700 dark:text-gray-300"></p>
            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                    onclick="hideModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="achievement-detail-modal" 
         class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0"
         onclick="closeAchievementDetails(event)"> 
        
        <div id="achievement-card" 
             class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-xs transform scale-50 opacity-0"
             onclick="event.stopPropagation()">
            
            <div id="detail-icon-container" 
                 class="w-40 h-40 rounded-full bg-blue-500 dark:bg-blue-600 flex items-center justify-center text-8xl mx-auto mb-6 shadow-xl 
                        transition-transform duration-300 ease-out">
                </div>
            
            <h3 id="detail-name" class="text-3xl font-bold mb-4 text-center text-gray-900 dark:text-white"></h3>
            
            <div class="p-4 border-2 border-dashed border-yellow-500 dark:border-yellow-400 rounded-xl mb-8 bg-yellow-50 dark:bg-gray-700">
                <p class="font-semibold text-yellow-700 dark:text-yellow-300 mb-2">–£—Å–ª–æ–≤–∏–µ:</p>
                <p id="detail-condition" class="text-lg text-gray-700 dark:text-gray-300"></p>
            </div>

            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                    onclick="closeAchievementDetails()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="friend-detail-modal" 
         class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0"
         onclick="closeFriendDetails(event)"> 
        
        <div id="friend-card" 
             class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-full max-w-xs transform scale-50 opacity-0"
             onclick="event.stopPropagation()">
            
            <div id="friend-detail-icon-container" 
                 class="w-40 h-40 rounded-full flex items-center justify-center text-8xl mx-auto mb-6 shadow-2xl 
                        transition-transform duration-300 ease-out">
                </div>
            
            <h3 id="friend-detail-name" class="text-3xl font-bold mb-2 text-center text-gray-900 dark:text-white"></h3>
            <p id="friend-detail-id" class="text-lg font-mono text-gray-500 dark:text-gray-400 mb-6 text-center"></p>

            <button id="visit-friend-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98 mb-4" 
                    >–ü–æ—Å–µ—Ç–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

            <button class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-xl 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                    onclick="closeFriendDetails()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>


    <script type="module">
        // üö® –õ–û–ö–ê–õ–¨–ù–´–ï –ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ò–ú–ò–¢–ê–¶–ò–ò üö®
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        const firebaseConfig = { apiKey: "fake", projectId: "local-test-app" };

        let userId = 'local-user-id-12345';
        let userData = {
            phoneNumber: null, uniqueId: null, location: null, themePreference: 'auto', name: '–ê–Ω–æ–Ω–∏–º', 
            avatarBase64: null 
        };
        
        // üíæ –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï: –ò–º–∏—Ç–∞—Ü–∏—è Firestore —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º localStorage
        const LOCAL_STORAGE_KEY = 'localAppUserData';
        
        function getLocalUserData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        }

        async function saveLocalUserData(data) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
        }
        
        const LOCATIONS = [
            "–¢–∏—Ä–∞—Å–ø–æ–ª—å", "–ë–µ–Ω–¥–µ—Ä—ã", "–†—ã–±–Ω–∏—Ü–∞", "–ë–ª. —Ö—É—Ç–æ—Ä", 
            "–ì—Ä–∏–≥–æ—Ä–∏–æ–ø–æ–ª—å", "–î–Ω–µ—Å—Ç—Ä–æ–≤—Å–∫", "–î—É–±–æ—Å—Å–∞—Ä—ã", "–ö–∞–º–µ–Ω–∫–∞", 
            "–ú–∞—è–∫", "–ù-—Ç–∏—Ä–∞—Å–ø–æ–ª—å.", "–ü–∞—Ä–∫–∞–Ω—ã", "–¢–µ—Ä–Ω–æ–≤–∫–∞", 
            "–ü–µ—Ä–≤–æ–º–∞–π—Å–∫", "–°–ª–æ–±–æ–¥–∑–µ—è", "–°—É–∫–ª–µ—è"
        ];
        
        const MOCK_ACHIEVEMENTS = [
            { name: "–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥", icon: "‚ú®", condition: "–ó–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–≤—ã–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–æ." },
            { name: "–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞", icon: "üìç", condition: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –º–µ–Ω—é." },
            { name: "–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º", icon: "üåô", condition: "–í–∫–ª—é—á–∏—Ç–µ —Ç–µ–º–Ω—É—é —Ç–µ–º—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è." },
            { name: "–°–º–µ–Ω–∞ –∏–º–µ–Ω–∏", icon: "‚úèÔ∏è", condition: "–ò–∑–º–µ–Ω–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ." },
            { name: "5 –¥–Ω–µ–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏", icon: "üóìÔ∏è", condition: "–ó–∞—Ö–æ–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ –ø—è—Ç–∏ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥." },
            { name: "–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", icon: "üî•", condition: "–°–æ–≤–µ—Ä—à–∏—Ç–µ 10 –¥–µ–π—Å—Ç–≤–∏–π (–≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞, —Å–º–µ–Ω–∞ —Ç–µ–º—ã, –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è)." },
            { name: "10 –¥—Ä—É–∑–µ–π", icon: "ü§ù", condition: "–î–æ–±–∞–≤—å—Ç–µ 10 –¥—Ä—É–∑–µ–π –≤ —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤." },
            { name: "–í—Å–µ –º–µ—Å—Ç–∞", icon: "üó∫Ô∏è", condition: "–ü–æ—Å–µ—Ç–∏—Ç–µ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ –≤—Å–µ 15 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–π." },
        ];

        const MOCK_FRIENDS = [
            { id: '123456', name: '–ò–≤–∞–Ω', avatar: 'üßëüèª‚Äçüíª', color: 'bg-yellow-400' },
            { id: '654321', name: '–ú–∞—Ä–∏—è', avatar: 'üë©üèª‚Äçüíª', color: 'bg-pink-400' },
            { id: '987654', name: '–ê–ª–µ–∫—Å', avatar: 'üßëüèº‚Äçüíª', color: 'bg-green-400' },
            { id: '456789', name: '–û–ª—å–≥–∞', avatar: 'üë©üèΩ‚Äçüíª', color: 'bg-indigo-400' },
            { id: '321987', name: '–î–º–∏—Ç—Ä–∏–π', avatar: 'üë®üèª‚Äçüíª', color: 'bg-red-400' },
            { id: '112233', name: '–ï–ª–µ–Ω–∞', avatar: 'üë©üèæ‚Äçüíª', color: 'bg-teal-400' },
            { id: '445566', name: '–°–µ—Ä–≥–µ–π', avatar: 'üßëüèø‚Äçüíª', color: 'bg-purple-400' },
            { id: '778899', name: '–ù–∞—Ç–∞–ª—å—è', avatar: 'üë©üèº‚Äçüíª', color: 'bg-orange-400' },
            { id: '001122', name: '–ü–∞–≤–µ–ª', avatar: 'üë®üèΩ‚Äçüíª', color: 'bg-cyan-400' },
            { id: '334455', name: '–ö–∞—Ç—è', avatar: 'üë©üèª‚Äçüíª', color: 'bg-lime-400' },
            { id: '667788', name: '–ì–µ–Ω–∞', avatar: 'üßëüèª‚Äçüíª', color: 'bg-blue-400' }
        ];

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI/UX ---

        window.showModal = function(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.querySelector('#modal > div').classList.remove('animate-out');
            document.querySelector('#modal > div').classList.add('animate-in');
        }

        window.hideModal = function() {
            const modal = document.getElementById('modal');
            document.querySelector('#modal > div').classList.remove('animate-in');
            document.querySelector('#modal > div').classList.add('animate-out');
            setTimeout(() => {
                 modal.classList.add('hidden');
                 modal.classList.remove('flex');
            }, 300);
        }
        
        function getCurrentTheme() {
            if (userData.themePreference === 'light') return 'light';
            if (userData.themePreference === 'dark') return 'dark';
            const pridnestrovieHour = (new Date().getUTCHours() + 3) % 24;
            return (pridnestrovieHour >= 8 && pridnestrovieHour < 18) ? 'light' : 'dark';
        }

        function applyTheme(theme) {
            const body = document.body;
            const container = document.getElementById('app-container');
            const toggleClasses = (element, add, remove) => {
                element.classList.add(...add);
                element.classList.remove(...remove);
            };
            const isDark = theme === 'dark';

            toggleClasses(body, isDark ? ['bg-gray-900', 'text-white'] : ['bg-white', 'text-gray-900'], isDark ? ['bg-white', 'text-gray-900'] : ['bg-gray-900', 'text-white']);
            toggleClasses(container, isDark ? ['bg-gray-800', 'shadow-gray-700'] : ['bg-white', 'shadow-blue-200'], isDark ? ['bg-white', 'shadow-blue-200'] : ['bg-gray-800', 'shadow-gray-700']);
            toggleClasses(document.getElementById('main-title'), isDark ? ['text-white'] : ['text-gray-900'], isDark ? ['text-gray-900'] : ['text-white']);
            toggleClasses(document.getElementById('profile-btn'), isDark ? ['bg-gray-700', 'text-white'] : ['bg-white', 'text-gray-800'], isDark ? ['bg-white', 'text-gray-800'] : ['bg-gray-700', 'text-white']);
        }
        
        // --- –§–£–ù–ö–¶–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–ª–∏–∫–æ–≤ ---
        function setupDragToScroll(container) {
            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragging = false; 

            const handlePointerDown = (e) => {
                isDown = true;
                isDragging = false;
                container.classList.add('cursor-grabbing');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º pageX –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏ touch-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                const clientX = (e.pageX || (e.touches && e.touches[0].pageX));
                startX = clientX - container.offsetLeft;
                scrollLeft = container.scrollLeft;
            };

            const handlePointerUp = () => {
                isDown = false;
                container.classList.remove('cursor-grabbing');
            };

            const handlePointerMove = (e) => {
                if (!isDown) return;
                
                const clientX = (e.pageX || (e.touches && e.touches[0].pageX));
                const currentX = clientX - container.offsetLeft;
                
                // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—ã—Å–∏–ª–æ 5 –ø–∏–∫—Å–µ–ª–µ–π, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                if (Math.abs(currentX - startX) > 5) {
                    isDragging = true;
                    e.preventDefault(); 
                }
                
                const walk = (currentX - startX) * 1.5; 
                container.scrollLeft = scrollLeft - walk;
            };

            // Desktop (Mouse events)
            container.addEventListener('mousedown', handlePointerDown);
            container.addEventListener('mouseleave', handlePointerUp);
            container.addEventListener('mouseup', handlePointerUp);
            container.addEventListener('mousemove', handlePointerMove);

            // Mobile (Touch events)
            container.addEventListener('touchstart', handlePointerDown);
            container.addEventListener('touchend', handlePointerUp);
            container.addEventListener('touchcancel', handlePointerUp);
            container.addEventListener('touchmove', handlePointerMove);
            
            // –ì–ê–†–ê–ù–¢–ò–Ø –ö–õ–ò–ö–ê: –ë–ª–æ–∫–∏—Ä—É–µ–º click, –µ—Å–ª–∏ –±—ã–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            container.addEventListener('click', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true); 
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù –° –ê–ù–ò–ú–ê–¶–ò–ï–ô ---
        
        window.openAchievementDetails = function(achievement) {
            const modal = document.getElementById('achievement-detail-modal');
            const card = document.getElementById('achievement-card');
            const iconContainer = document.getElementById('detail-icon-container');

            iconContainer.innerHTML = achievement.icon;
            document.getElementById('detail-name').textContent = achievement.name;
            document.getElementById('detail-condition').textContent = achievement.condition;

            modal.classList.remove('hidden');
            modal.classList.add('flex', 'opacity-0'); 
            card.classList.remove('animate-out-ach');
            card.classList.add('scale-50', 'opacity-0'); 
            
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                card.classList.remove('scale-50', 'opacity-0');
                card.classList.add('scale-100', 'opacity-100', 'animate-in-ach'); 
            }, 10);
        };

        window.closeAchievementDetails = function(event) {
            if (event && event.currentTarget !== event.target) return;
            
            const modal = document.getElementById('achievement-detail-modal');
            const card = document.getElementById('achievement-card');

            modal.classList.add('opacity-0');
            card.classList.remove('animate-in-ach');
            card.classList.add('animate-out-ach'); 

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                card.classList.remove('animate-out-ach', 'scale-100', 'opacity-100');
                card.classList.add('scale-50', 'opacity-0');
            }, 500); 
        };
        
        window.openFriendDetails = function(friend) {
            const modal = document.getElementById('friend-detail-modal');
            const card = document.getElementById('friend-card');
            const iconContainer = document.getElementById('friend-detail-icon-container');

            iconContainer.innerHTML = friend.avatar;
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞, —á—Ç–æ–±—ã –∞–≤–∞—Ç–∞—Ä –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
            iconContainer.className = `w-40 h-40 rounded-full ${friend.color} flex items-center justify-center text-8xl mx-auto mb-6 shadow-2xl transition-transform duration-300 ease-out`;

            document.getElementById('friend-detail-name').textContent = friend.name;
            document.getElementById('friend-detail-id').textContent = `ID: ${friend.id}`;

            document.getElementById('visit-friend-btn').onclick = () => {
                closeFriendDetails(); 
                setTimeout(() => {
                    showModal('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å', `–í—ã –∏–º–∏—Ç–∏—Ä—É–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${friend.name}.`);
                }, 550);
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex', 'opacity-0'); 
            card.classList.remove('animate-out-ach');
            card.classList.add('scale-50', 'opacity-0'); 
            
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                card.classList.remove('scale-50', 'opacity-0');
                card.classList.add('scale-100', 'opacity-100', 'animate-in-ach'); 
            }, 10);
        };

        window.closeFriendDetails = function(event) {
            if (event && event.currentTarget !== event.target) return;
            
            const modal = document.getElementById('friend-detail-modal');
            const card = document.getElementById('friend-card');

            modal.classList.add('opacity-0');
            card.classList.remove('animate-in-ach');
            card.classList.add('animate-out-ach'); 

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                card.classList.remove('animate-out-ach', 'scale-100', 'opacity-100');
                card.classList.add('scale-50', 'opacity-0');
            }, 500); 
        };

        // --- –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –î–ê–ù–ù–´–• (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        
        function generateUniqueId() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function loadUserData(uid) {
            try {
                const loadedData = getLocalUserData();
                if (loadedData && loadedData.uniqueId) {
                    userData = { ...userData, ...loadedData }; 
                    if (!userData.name) userData.name = '–ê–Ω–æ–Ω–∏–º';
                    if (!userData.avatarBase64) userData.avatarBase64 = null;
                    applyTheme(getCurrentTheme());
                    renderMainMenu();
                } else {
                    renderAuthScreen();
                }
            } catch (error) {
                renderAuthScreen(); 
            }
        }

        async function saveUserData(newFields = {}) {
            if (!userId) return;
            try {
                userData = { ...userData, ...newFields };
                await saveLocalUserData(userData);
                applyTheme(getCurrentTheme());
                if (newFields.location) {
                    showModal("–£—Å–ø–µ—à–Ω–æ!", `–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${newFields.location}.`);
                }
                if (newFields.themePreference) {
                    showModal("–£—Å–ø–µ—à–Ω–æ!", `–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.`);
                }
            } catch (error) {
                showModal("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (LocalStorage error).");
            }
        }

        window.handleAvatarUpload = function(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                showModal("–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                return;
            }
            if (file.size > 500 * 1024) {
                showModal("–û—à–∏–±–∫–∞", "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 500 –ö–ë.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                saveUserData({ avatarBase64: e.target.result });
                showModal("–ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω", "–í–∞—à–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
                setTimeout(renderProfile, 100); 
            };
            reader.readAsDataURL(file);
        };


        // --- –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ò–ù–ì–ê (–û–ë–ù–û–í–õ–ï–ù–´) ---

        function renderAuthScreen() {
            document.getElementById('profile-btn').classList.add('hidden');
            document.getElementById('main-title').textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!";
            document.getElementById('content').innerHTML = `
                <p class="mb-6 text-lg">–î–ª—è –≤—Ö–æ–¥–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å".</p>
                <button id="auth-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-md 
                                            bg-blue-600 hover:bg-blue-700 text-white 
                                            transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                        onclick="requestContact()">
                    –ù–∞—á–∞—Ç—å (–ò–º–∏—Ç–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
                </button>
            `;
        }

        window.renderMainMenu = function() {
            document.getElementById('profile-btn').classList.remove('hidden');
            document.getElementById('main-title').textContent = "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é";
            const content = document.getElementById('content');
            
            const uniqueIdDisplay = userData.uniqueId ? `<p class="text-sm mb-4">–í–∞—à ID: <span class="font-mono font-bold text-lg">${userData.uniqueId}</span></p>` : '';
            const currentLocation = userData.location ? `<p class="text-xl font-semibold mb-6 p-3 rounded-lg bg-gray-100 dark:bg-gray-700">–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ: ${userData.location}</p>` : `<p class="text-xl font-semibold mb-6">–í—ã–±–µ—Ä–µ—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p>`;

            let buttonsHtml = LOCATIONS.map(location => `
                <button class="location-btn w-full sm:w-1/2 lg:w-1/3 p-3 m-1 font-medium rounded-lg shadow-md 
                                transition transform duration-200 hover:scale-[1.03] active:scale-95 
                                ${userData.location === location ? 'bg-green-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'}" 
                        onclick="selectLocation('${location}')">
                    ${location}
                </button>
            `).join('');

            content.innerHTML = `${uniqueIdDisplay}${currentLocation}<div class="flex flex-wrap justify-center gap-2">${buttonsHtml}</div>`;
        }
        
        window.renderProfile = function() {
            document.getElementById('profile-btn').classList.add('hidden'); 
            document.getElementById('main-title').textContent = "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å";
            const content = document.getElementById('content');
            const isDark = getCurrentTheme() === 'dark';
            
            const avatarContent = userData.avatarBase64 
                ? `<img src="${userData.avatarBase64}" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full h-full rounded-full object-cover">` 
                : 'üë§'; 

            // --- Friends HTML ---
            const totalFriends = MOCK_FRIENDS.length; 
            const escapedFriends = MOCK_FRIENDS.map(f => JSON.stringify(f).replace(/'/g, "\\'"));
            const friendsHtml = MOCK_FRIENDS.map((f, index) => `
                <div class="flex flex-col items-center flex-shrink-0 w-[55px] min-w-[55px] p-0.5 
                            transition-transform duration-200 hover:scale-105 active:scale-95 cursor-pointer" 
                     onclick="openFriendDetails(${escapedFriends[index]})">
                    <div class="w-10 h-10 rounded-full ${f.color} flex items-center justify-center text-lg overflow-hidden mb-0.5 shadow-md">
                        ${f.avatar} 
                    </div> 
                    <span class="text-[10px] h-3 text-center truncate w-full font-medium text-gray-700 dark:text-gray-300">${f.name}</span>
                </div>
            `).join('');

            // --- Achievements HTML ---
            const totalAchievements = MOCK_ACHIEVEMENTS.length; 
            const escapedAchievements = MOCK_ACHIEVEMENTS.map(a => JSON.stringify(a).replace(/'/g, "\\'"));

            const achievementsHtml = MOCK_ACHIEVEMENTS.map((a, index) => `
                <div class="flex flex-col items-center flex-shrink-0 w-[65px] min-w-[65px] p-0.5 
                            transition-transform duration-200 hover:scale-105 active:scale-95 cursor-pointer"
                     onclick="openAchievementDetails(${escapedAchievements[index]})">
                    <div class="w-12 h-12 rounded-xl bg-blue-500 dark:bg-blue-600 flex items-center justify-center text-2xl mb-1 shadow-lg 
                                transition-colors duration-300 hover:bg-blue-400 dark:hover:bg-blue-500">
                        ${a.icon}
                    </div>
                    <span class="text-[10px] h-6 text-center w-full font-medium text-gray-700 dark:text-gray-300 overflow-hidden">${a.name}</span>
                </div>
            `).join('');
            
            content.innerHTML = `
                <div class="flex justify-end w-full">
                    <button class="p-2 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 
                                   transition transform duration-200 hover:rotate-6 active:rotate-0" 
                            onclick="renderSettings()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-2.82-.41-5.02-2.58-5.43-5.4l1.45-.63c.2.66.47 1.28.79 1.85l-.57.85c.32.48-.6.98-.82 1.5l.59.85c.41-.09.8-.23 1.17-.42l.52 1.51zm3.83-4.59c-.43.43-.92.83-1.44 1.18l.55.82c.51.34 1.05.62 1.6.83l.59-1.55c-.17-.35-.3-.72-.41-1.1zm.41-5.11l-1.45.63c-.2-.66-.47-1.28-.79-1.85l.57-.85c.32-.48.6-.98.82-1.5l-.59-.85c-.41.09-.8.23-1.17.42l-.52-1.51c2.82.41 5.02 2.58 5.43 5.4l-1.45.63zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"></path></svg>
                        <span class="sr-only">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                </div>

                <div class="flex flex-col items-center mb-6">
                    <div class="relative mb-3">
                        <div class="w-24 h-24 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-5xl text-blue-600 dark:text-blue-200 shadow-xl transition-all duration-300 hover:shadow-blue-500/50 overflow-hidden">
                            ${avatarContent}
                        </div>
                        <input type="file" id="avatar-input" accept="image/jpeg, image/png" class="hidden" onchange="handleAvatarUpload(event)">
                        <button class="absolute bottom-0 right-0 p-1 bg-green-500 text-white rounded-full shadow-md 
                                       transition transform duration-200 hover:scale-125 active:scale-90" 
                                onclick="document.getElementById('avatar-input').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        </button>
                    </div>
                    
                    <p class="text-3xl font-bold">${userData.name}</p>
                    <p class="text-lg font-mono text-gray-500 dark:text-gray-400">ID: ${userData.uniqueId}</p>
                    
                    <div class="mt-4 w-full max-w-xs">
                        <label for="profile-name-input" class="block text-sm font-medium mb-1 text-left">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è (–¥–æ 12 –±—É–∫–≤):</label>
                        <div class="flex space-x-2">
                            <input type="text" id="profile-name-input" 
                                value="${userData.name}" maxlength="12" 
                                class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 
                                    ${isDark ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-900 border-gray-300'}">
                            <button class="bg-blue-600 text-white p-2 rounded-lg font-semibold 
                                            transition transform duration-200 hover:scale-[1.05] active:scale-95" 
                                    onclick="saveProfileName()">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="my-6 border-gray-200 dark:border-gray-700">

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-left">
                        –ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 
                        <span class="text-base text-gray-500 dark:text-gray-400">(${totalAchievements})</span>
                    </h2>
                    <button class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-150"
                            onclick="showModal('–í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è', '–ó–¥–µ—Å—å –±—É–¥–µ—Ç —ç–∫—Ä–∞–Ω —Å–æ –≤—Å–µ–º–∏ ${totalAchievements} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏.')">
                        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                    </button>
                </div>
                <div id="achievements-list" 
                     class="overflow-x-auto hide-scrollbar whitespace-nowrap mb-8 p-2 rounded-xl border border-gray-200 dark:border-gray-700 cursor-grab" 
                     style="-webkit-overflow-scrolling: touch; display: flex; flex-wrap: nowrap;">
                    <div class="flex gap-1">
                        ${achievementsHtml}
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-left">
                        –ú–æ–∏ –¥—Ä—É–∑—å—è 
                        <span class="text-base text-gray-500 dark:text-gray-400">(${totalFriends})</span>
                    </h2>
                    <button class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-150"
                            onclick="showModal('–í—Å–µ –¥—Ä—É–∑—å—è', '–ó–¥–µ—Å—å –±—É–¥–µ—Ç —ç–∫—Ä–∞–Ω —Å–æ –≤—Å–µ–º–∏ ${totalFriends} –¥—Ä—É–∑—å—è–º–∏.')">
                        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
                    </button>
                </div>
                <div id="friends-list" 
                     class="overflow-x-auto hide-scrollbar whitespace-nowrap mb-8 p-2 rounded-xl border border-gray-200 dark:border-gray-700 cursor-grab" 
                     style="-webkit-overflow-scrolling: touch; display: flex; flex-wrap: nowrap;">
                    <div class="flex gap-1">
                        ${friendsHtml}
                    </div>
                </div>

                <button class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-md 
                                bg-gray-500 hover:bg-gray-600 text-white 
                                transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                        onclick="renderMainMenu()">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é
                </button>
            `;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º –¥–ª—è –æ–±–æ–∏—Ö —Å–ø–∏—Å–∫–æ–≤
            const friendsList = document.getElementById('friends-list');
            const achievementsList = document.getElementById('achievements-list');

            if (friendsList) {
                setupDragToScroll(friendsList);
            }
            if (achievementsList) {
                setupDragToScroll(achievementsList);
            }
        }
        
        window.saveProfileName = function() {
            const input = document.getElementById('profile-name-input');
            let newName = input.value.trim();
            if (newName.length === 0 || newName.length > 12) {
                showModal("–û—à–∏–±–∫–∞", "–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤.");
                return;
            }
            saveUserData({ name: newName });
            setTimeout(renderProfile, 300); 
        }

        window.renderSettings = function() {
            document.getElementById('profile-btn').classList.add('hidden'); 
            document.getElementById('main-title').textContent = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏";
            const content = document.getElementById('content');
            
            const themeOptions = [
                { value: 'auto', label: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–î–µ–Ω—å/–ù–æ—á—å)' },
                { value: 'light', label: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ë–µ–ª—ã–π (–î–µ–Ω—å)' },
                { value: 'dark', label: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ß–µ—Ä–Ω—ã–π (–ù–æ—á—å)' }
            ];

            const themeRadios = themeOptions.map(option => `
                <label class="flex items-center space-x-3 cursor-pointer py-2 
                              transition transform duration-150 hover:scale-[1.01]">
                    <input type="radio" name="theme-pref" value="${option.value}" 
                           ${userData.themePreference === option.value ? 'checked' : ''}
                           class="form-radio h-5 w-5 text-blue-600" onchange="updateThemePreference(this.value)">
                    <span class="text-lg">${option.label}</span>
                </label>
            `).join('');

            content.innerHTML = `
                <div class="text-left mb-6 p-4 rounded-lg bg-gray-100 dark:bg-gray-700">
                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">–í—ã–±–æ—Ä —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
                    ${themeRadios}
                </div>
                
                <button class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-md 
                                bg-gray-500 hover:bg-gray-600 text-white 
                                transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                        onclick="renderProfile()">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å
                </button>
            `;
        }
        
        window.requestContact = function() {
            document.getElementById('content').innerHTML = `<div class="p-4 bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-100 rounded-lg">
                <p>–ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞...</p>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã.</p>
            </div>`;
            setTimeout(completeRegistration, 1500);
        }
        
         window.selectLocation = function(location) {
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ
            saveUserData({ location: location });

            // 2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ menu.html
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É "–£—Å–ø–µ—à–Ω–æ!" –ø–æ—è–≤–∏—Ç—å—Å—è –∏ –∏—Å—á–µ–∑–Ω—É—Ç—å –∫—Ä–∞—Å–∏–≤–æ
            setTimeout(() => {
                window.location.href = 'menu.html';
            }, 500); 
        }

        window.updateThemePreference = function(preference) {
            saveUserData({ themePreference: preference });
        }

        async function initializeFirebase() {
            try {
                initializeApp(firebaseConfig);
                getAuth();
                getFirestore(); 
                loadUserData(userId); 
            } catch (error) {
                document.getElementById('content').innerHTML = `<p class="text-red-500">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –¥–ª—è CDN)</p>`;
            }
        }
        
        async function completeRegistration() {
            if (!userId) return;

            const existingData = getLocalUserData();

            if (!existingData) {
                userData = {
                    phoneNumber: "N/A (–ò–º–∏—Ç–∞—Ü–∏—è)", 
                    uniqueId: generateUniqueId(),
                    location: null,
                    themePreference: 'auto',
                    name: '–ê–Ω–æ–Ω–∏–º', 
                    avatarBase64: null,
                    createdAt: new Date().toISOString()
                };
                await saveLocalUserData(userData);
                showModal("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!", `–í–∞–º –ø—Ä–∏—Å–≤–æ–µ–Ω ID: ${userData.uniqueId}.`);
            } else {
                userData = existingData;
                if (!userData.name) userData.name = '–ê–Ω–æ–Ω–∏–º';
                if (!userData.avatarBase64) userData.avatarBase64 = null;
            }
            
            applyTheme(getCurrentTheme());
            renderMainMenu();
        }
        
        window.onload = function () {
            initializeFirebase();
        }
    </script>
</body>
</html>