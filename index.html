<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ß–ê–¢ - –î–∏–∞–ª–æ–≥–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –∏ –∞–Ω–∏–º–∞—Ü–∏–π */
        .hide-scrollbar::-webkit-scrollbar { height: 0px; width: 0px; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-out { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes slideLeftIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideRightOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-20px); } }
        .screen-transition-in { animation: slideLeftIn 0.4s ease-out forwards; }
        .screen-transition-out { animation: slideRightOut 0.4s ease-in forwards; }
        
        #app-container {
            height: 90vh; max-height: 800px; display: flex; flex-direction: column; overflow: hidden;
        }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-900 { color: #ffffff; }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è Swipe-to-Reveal --- */
        .chat-item-container {
            position: relative;
            overflow: hidden; 
            margin-bottom: 8px; 
            border-radius: 0.75rem; 
            background-color: #374151; /* –§–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –ø—Ä–∏ —Å–¥–≤–∏–≥–µ */
            /* –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Å–≤–∞–π–ø–µ */
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, –Ω–æ –¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º */
        }
        .chat-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 120px; /* –®–∏—Ä–∏–Ω–∞ 2-—Ö –∫–Ω–æ–ø–æ–∫ */
            display: flex;
            align-items: center;
            z-index: 0;
        }
        .chat-content {
            position: relative;
            z-index: 1;
            /* –£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è, –ø—Ä—É–∂–∏–Ω–∏—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            cursor: pointer;
            background-color: #4b5563; /* bg-gray-700 */
        }
        .chat-content.swiped {
            transform: translateX(-120px); 
        }
        
        .chat-actions button {
            width: 60px; 
            height: 100%;
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            font-size: 0.75rem;
            line-height: 1rem;
            border-radius: 0;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-xl p-0 rounded-xl shadow-2xl transition-colors duration-500">
        
        <div id="header" class="relative flex-shrink-0 p-4 border-b dark:border-gray-700 flex justify-between items-center">
             <button id="back-btn" class="p-1 rounded-full shadow-lg transition transform duration-200 hover:scale-110 active:scale-90 hidden" 
                     onclick="goBack()">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
             </button>
             <div class="flex-grow flex items-center min-w-0">
                 <div id="chat-header-avatar" class="w-10 h-10 rounded-full bg-blue-500 dark:bg-blue-600 flex items-center justify-center text-xl mr-3 flex-shrink-0">
                    </div>
                 <div id="chat-header-info" class="truncate">
                    <h1 id="main-title" class="text-xl font-bold truncate">–î–∏–∞–ª–æ–≥–∏</h1> 
                    <p id="chat-status" class="text-xs text-gray-500 dark:text-gray-400 truncate"></p>
                 </div>
             </div>
             <div class="flex items-center space-x-2">
                 <button id="app-back-btn" class="p-1 rounded-full shadow-lg transition transform duration-200 hover:scale-110 active:scale-90" 
                         onclick="showModal('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', '–ò–º–∏—Ç–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω –∏–ª–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.')">
                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                 </button>
                 <button id="new-chat-btn" class="p-1 rounded-full shadow-lg transition transform duration-200 hover:scale-110 active:scale-90" 
                         onclick="openNewChatModal()">
                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-plus"><path d="M21 15V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14l3.5-2h12a2 2 0 0 0 2-2Z"/><path d="M12 7v6"/><path d="M15 10h-6"/></svg>
                 </button>
             </div>
        </div>
        
        <div id="search-container" class="flex-shrink-0 p-4 border-b dark:border-gray-700">
            <input type="text" id="search-input" oninput="filterDialogues(this.value)" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID..." 
                   class="w-full p-2 rounded-xl border border-gray-600 bg-gray-700 text-white 
                          focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="content" class="flex-grow p-4 overflow-y-auto hide-scrollbar">
            </div>

        <div id="chat-input-container" class="flex-shrink-0 p-3 border-t dark:border-gray-700 hidden">
            <div class="flex items-center space-x-2">
                
                <button id="emoji-picker-btn" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 text-2xl 
                                                    transition transform duration-200 hover:scale-110 active:scale-90"
                        onclick="showEmojiSelectionModal()">
                    üòÄ
                </button>
                
                <textarea id="message-input" 
                          placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                          rows="1"
                          class="flex-grow p-3 rounded-xl border border-gray-600 dark:border-gray-600 
                                 bg-gray-700 dark:bg-gray-700 text-white dark:text-white 
                                 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-hidden"
                          oninput="autoResizeTextarea(this); checkInputForSend(this)"
                          onkeydown="handleKeydown(event)"></textarea>

                <button id="send-btn" class="p-2 rounded-full bg-blue-600 text-white shadow-lg 
                                           transition transform duration-200 hover:scale-110 active:scale-90" 
                        onclick="sendMessage()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal">
                        <path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/>
                    </svg>
                </button>
            </div>
        </div>

    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">–°–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <p id="modal-message" class="mb-6 text-gray-300"></p>
            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                    onclick="hideModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div id="emoji-selection-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center p-4 z-50">
        <div id="emoji-selection-card" class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-6 text-white border-b pb-4 border-gray-700">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</h3>
            <div id="emoji-grid" class="grid grid-cols-8 gap-3 max-h-80 overflow-y-auto hide-scrollbar">
                </div>
            <button class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98 mt-6" 
                    onclick="closeEmojiSelectionModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div id="new-chat-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center p-4 z-50">
        <div id="new-chat-modal-card" class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-white border-b pb-3 border-gray-700">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>
            
            <p class="text-sm text-gray-400 mb-4">–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.</p>
            
            <input type="text" id="target-user-id" 
                   placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123456)"
                   class="w-full p-3 mb-6 rounded-lg border border-gray-600 bg-gray-700 text-white 
                          focus:outline-none focus:ring-2 focus:ring-blue-500">
                          
            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98" 
                    onclick="startNewChat()">–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
                    
            <button class="w-full bg-transparent border border-gray-600 hover:bg-gray-700 text-gray-300 font-semibold py-3 px-4 rounded-lg 
                           transition transform duration-200 hover:scale-[1.02] active:scale-98 mt-2" 
                    onclick="closeNewChatModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>


    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ (–∏–º–∏—Ç–∞—Ü–∏—è) ---
        const LOCAL_STORAGE_KEY = 'localChatUserData';
        
        function getLocalUserData() {
             const data = localStorage.getItem(LOCAL_STORAGE_KEY);
             return data ? JSON.parse(data) : null;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userData = {
            uniqueId: getLocalUserData() ? getLocalUserData().uniqueId : '543210',
            themePreference: getLocalUserData() ? getLocalUserData().themePreference : 'dark', 
            name: getLocalUserData() ? getLocalUserData().name || '–Ø' : '–Ø', 
            avatar: getLocalUserData() ? getLocalUserData().avatar || 'üë§' : 'üë§', 
            lastOnline: new Date().toISOString()
        };
        
        const contentElement = document.getElementById('content');
        const titleElement = document.getElementById('main-title');
        const backBtn = document.getElementById('back-btn'); 
        const appBackBtn = document.getElementById('app-back-btn'); 
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatInputContainer = document.getElementById('chat-input-container');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const chatStatus = document.getElementById('chat-status');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const searchContainer = document.getElementById('search-container');
        
        let screenHistory = ['dialoguesList']; 
        let currentScreen = 'dialoguesList';
        let activeChat = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–≤–∞–π–ø–∞ 
        let xDown = null;
        let yDown = null;
        let currentSwipedChat = null; 
        let isSwiping = false; 
        const swipeThreshold = 10; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–≤–∞–π–ø–∞
        const maxSwipe = 120; // –®–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–æ–∫

        // --- MOCK –î–ê–ù–ù–´–ï –î–õ–Ø –ß–ê–¢–ê (–°–∏–º—É–ª—è—Ü–∏—è) ---
        
        const EMOJI_LIST = [
            'üòÄ', 'üòÇ', 'üòç', 'üò≠', 'ü§Ø', 'ü•≥', 'üòé', 'üòú', 'üòá', 'ü§´', 'üôà', 'üôâ', 'üôä', 'üëç', 
            'üôè', '‚ù§Ô∏è', 'üî•', 'üíØ', 'üëã', '‚≠ê', '‚òÄÔ∏è', '‚òî', 'üí∞', 'üîë', 'üì©', 'üîó', '‚è≥', 'üíª',
            'üê∂', 'üê±', 'ü¶ä', 'üêª', 'üçï', 'üçî', 'üåÆ', 'üç©', '‚òï', 'üçæ', 'üéâ', 'üéÅ', 'üéà', 'üíç', 
            'üöó', '‚úàÔ∏è', 'üè†', 'üí°', '‚è∞', 'üìö', '‚úèÔ∏è', 'üìç', '‚úÖ', '‚ùå', '‚ùì', '‚ùï', '‚ùó', '‚ôªÔ∏è'
        ];
        
        let MOCK_CHATS_DATA = [
            { id: 'chat_1', userId: '123456', name: '–ò–≤–∞–Ω', avatar: 'üßëüèª‚Äçüíª', lastMessage: '–°–≤—è–∑—å –ø–æ ID —Ä–∞–±–æ—Ç–∞–µ—Ç.', lastSeen: Date.now() - 300000, unreadCount: 1 },
            { id: 'chat_2', userId: '654321', name: '–ú–∞—Ä–∏—è', avatar: 'üë©üèª‚Äçüíª', lastMessage: '–ù–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏! üòÇ', lastSeen: Date.now() - 1200000, unreadCount: 0 },
            { id: 'chat_3', userId: '987654', name: '–ê–ª–µ–∫—Å', avatar: 'üßëüèº‚Äçüíª', lastMessage: '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.', lastSeen: Date.now() - 86400000 * 2, unreadCount: 0 }
        ];

        let MOCK_MESSAGES = {
            'chat_1': [
                { senderId: '123456', text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?', timestamp: Date.now() - 360000 },
                { senderId: userData.uniqueId, text: '–û—Ç–ª–∏—á–Ω–æ! –¢–µ—Å—Ç–∏—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ ID. üöÄ', timestamp: Date.now() - 350000 },
                { senderId: '123456', text: '–°–≤—è–∑—å –ø–æ ID —Ä–∞–±–æ—Ç–∞–µ—Ç.', timestamp: Date.now() - 300000 }
            ],
            'chat_2': [
                { senderId: '654321', text: '–≠—Ç–æ—Ç —á–∞—Ç –æ—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤—ã–π. ü§©', timestamp: Date.now() - 1800000 },
                { senderId: userData.uniqueId, text: '–°–ø–∞—Å–∏–±–æ! –ê —Ç–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π —ç–º–æ–¥–∑–∏. ü•≥', timestamp: Date.now() - 1500000 },
                { senderId: '654321', text: '–ù–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏! üòÇ', timestamp: Date.now() - 1200000 }
            ],
            'chat_3': [
                { senderId: userData.uniqueId, text: '–ù–∞—á–∏–Ω–∞–µ–º —á–∞—Ç.', timestamp: Date.now() - 86400000 * 2 }
            ]
        };
        
        // --- –õ–æ–≥–∏–∫–∞ Swipe-to-Reveal (–û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) ---
        
        function getTouches(evt) {
            return evt.touches || evt.originalEvent.touches;
        }

        function handleTouchStart(evt) {
            if (currentScreen !== 'dialoguesList') return;
            
            // –ï—Å–ª–∏ —Å–≤–∞–π–ø–∞–µ–º –ø–æ —É–∂–µ —Å–¥–≤–∏–Ω—É—Ç–æ–º—É —á–∞—Ç—É, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
            if (currentSwipedChat && currentSwipedChat !== evt.currentTarget.id) {
                resetSwipedChat(currentSwipedChat);
            }
            
            const firstTouch = getTouches(evt)[0] || evt;
            xDown = firstTouch.clientX;
            yDown = firstTouch.clientY;
            currentSwipedChat = evt.currentTarget.id;
            isSwiping = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        }

        function handleTouchMove(evt) {
            if (currentScreen !== 'dialoguesList' || !xDown || !yDown || !currentSwipedChat) return;

            const xUp = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const yUp = evt.touches ? evt.touches[0].clientY : evt.clientY;

            const xDiff = xDown - xUp;
            const yDiff = yDown - yUp;
            
            const chatContent = document.getElementById(currentSwipedChat)?.querySelector('.chat-content');
            if (!chatContent) return;
            
            // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            if (Math.abs(xDiff) > swipeThreshold || Math.abs(yDiff) > swipeThreshold) { 
                
                if (Math.abs(xDiff) > Math.abs(yDiff) * 1.5) { // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç
                    
                    // --- –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ---
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞
                    evt.preventDefault();
                    isSwiping = true;
                    
                    if (xDiff > 0) { // –°–≤–∞–π–ø –≤–ª–µ–≤–æ
                        let swipeAmount = Math.min(xDiff, maxSwipe);
                        chatContent.style.transform = `translateX(-${swipeAmount}px)`;
                    } else { // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ
                        // –ï—Å–ª–∏ —É–∂–µ —Å–¥–≤–∏–Ω—É—Ç, —É–º–µ–Ω—å—à–∞–µ–º —Å–¥–≤–∏–≥
                        let currentSwipe = maxSwipe; 
                        if (!chatContent.classList.contains('swiped')) {
                            // –ï—Å–ª–∏ –Ω–µ –±—ã–ª –∑–∞–∫—Ä–µ–ø–ª–µ–Ω, –±–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π transform
                             currentSwipe = parseFloat(chatContent.style.transform.replace('translateX(-', '').replace('px)', '')) || 0;
                        }

                        let newSwipe = Math.max(0, currentSwipe + xDiff); 
                        chatContent.style.transform = `translateX(-${newSwipe}px)`;
                    }

                } else if (isSwiping) {
                    // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Å–≤–∞–π–ø–∞, –Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ —Å—Ç–∞–ª–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º, –≤—Å—ë —Ä–∞–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É,
                    // –ø–æ–∫–∞ –Ω–µ –æ—Ç–ø—É—Å—Ç–∏–º –ø–∞–ª–µ—Ü. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.
                    evt.preventDefault();
                } else {
                    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–∫—Ä–æ–ª–ª
                    xDown = null;
                    yDown = null;
                }
            }
        }

        function handleTouchEnd(evt) {
            if (currentScreen !== 'dialoguesList' || !currentSwipedChat) return;

            const chatContent = document.getElementById(currentSwipedChat)?.querySelector('.chat-content');
            if (!chatContent) return;
            
            const currentTransform = chatContent.style.transform;
            const currentX = parseFloat(currentTransform.replace('translateX(-', '').replace('px)', '')) || 0;
            const activationThreshold = maxSwipe / 2; // 60px

            if (isSwiping) {
                 evt.preventDefault(); // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–ª–∏–∫, –µ—Å–ª–∏ –±—ã–ª —Å–≤–∞–π–ø
            }
            
            if (currentX >= activationThreshold) {
                // –ó–∞–∫—Ä–µ–ø–ª—è–µ–º –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏
                chatContent.classList.add('swiped');
                chatContent.style.transform = `translateX(-${maxSwipe}px)`;
            } else {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º
                resetSwipedChat(currentSwipedChat);
            }
            
            // –°–±—Ä–æ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            xDown = null;
            yDown = null;
            
            // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —Å–≤–∞–π–ø–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∫–ª–∏–∫ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => { isSwiping = false; }, 350); 
        }
        
        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å–¥–≤–∏–Ω—É—Ç—ã—Ö —á–∞—Ç–æ–≤
        window.resetSwipedChat = function(chatIdToReset = null) {
            const selector = chatIdToReset ? `#${chatIdToReset} .chat-content` : '.chat-content.swiped';
            document.querySelectorAll(selector).forEach(el => {
                if (el.classList.contains('swiped') || el.style.transform.includes('-')) {
                    el.classList.remove('swiped');
                    el.style.transform = `translateX(0px)`;
                }
            });
            // –ï—Å–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–¥–≤–∏–Ω—É—Ç—ã–π, —Ç–æ –æ–±–Ω—É–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            if (chatIdToReset === currentSwipedChat) {
                currentSwipedChat = null;
            }
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π ---
        
        window.handleChatClick = function(chatId) {
            // –ï—Å–ª–∏ —Ñ–ª–∞–≥ isSwiping –∞–∫—Ç–∏–≤–µ–Ω, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –±—ã–ª —Å–≤–∞–π–ø, –∞ –Ω–µ –∫–ª–∏–∫
            if (isSwiping) {
                return;
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥—Ä—É–≥–æ–π —á–∞—Ç, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            if (document.querySelector('.chat-content.swiped')) {
                resetSwipedChat();
                // –¢–∞–∫ –∫–∞–∫ —Å–±—Ä–æ—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, –º–æ–∂–µ–º –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π,
                // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∞–Ω–∏–º–∞—Ü–∏–π.
                setTimeout(() => screenTransition(() => renderChatScreen(chatId)), 300);
            } else {
                screenTransition(() => renderChatScreen(chatId));
            }
        }

        window.deleteChat = function(chatId) {
            MOCK_CHATS_DATA = MOCK_CHATS_DATA.filter(chat => chat.id !== chatId);
            delete MOCK_MESSAGES[chatId];

            const chatEl = document.getElementById(chatId);
            if(chatEl) {
                 chatEl.style.maxHeight = chatEl.offsetHeight + 'px';
                 chatEl.style.opacity = 1;
                 chatEl.style.transition = 'opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease';
                 
                 setTimeout(() => {
                     chatEl.style.opacity = 0;
                     chatEl.style.maxHeight = '0px';
                     chatEl.style.marginBottom = '0px';
                 }, 50);
                 
                 setTimeout(() => {
                     chatEl.remove();
                     renderDialoguesList(MOCK_CHATS_DATA); 
                 }, 400);
            }

            showModal('–£—Å–ø–µ—à–Ω–æ', `–î–∏–∞–ª–æ–≥ ${chatId} –±—ã–ª —É–¥–∞–ª–µ–Ω.`);
        }

        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (applyTheme, updateScreenState, goBack, updateHeader, filterDialogues, openNewChatModal, closeNewChatModal, startNewChat, renderDialoguesList, renderChatScreen, sendMessage, getLastSeenText, screenTransition, autoResizeTextarea, checkInputForSend, handleKeydown, showModal, hideModal, showEmojiSelectionModal, closeEmojiSelectionModal, insertEmoji) ---
        // (–û–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ –ª–æ–≥–∏–∫–∏ –≤—ã–∑–æ–≤–∞ handleChatClick –≤ renderDialoguesList)
        
        // --- –§–£–ù–ö–¶–ò–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê, –ò–ó–ú–ï–ù–ï–ù–ê –¢–û–õ–¨–ö–û –õ–û–ì–ò–ö–ê ONCLICK ---
        window.renderDialoguesList = function(data = MOCK_CHATS_DATA) {
            updateHeader('–î–∏–∞–ª–æ–≥–∏', '–í–∞—à ID: ' + userData.uniqueId, 'üí¨');
            updateScreenState('dialoguesList');
            
            if (data.length === 0) {
                 contentElement.innerHTML = `<div class="p-4 text-center text-gray-400">
                                                <p class="text-3xl mb-3">üîé</p>
                                                <p>–î–∏–∞–ª–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</p>
                                             </div>`;
                return;
            }

            const html = data.map(chat => {
                const friend = chat;
                const status = getLastSeenText(friend.lastSeen);
                const unreadBadge = friend.unreadCount > 0 ? 
                    `<span class="flex items-center justify-center w-6 h-6 ml-2 text-xs font-bold text-white bg-red-500 rounded-full flex-shrink-0">${friend.unreadCount}</span>` : '';
                
                return `
                    <div id="${friend.id}" class="chat-item-container rounded-xl"
                         ontouchstart="handleTouchStart(event)" 
                         ontouchmove="handleTouchMove(event)" 
                         ontouchend="handleTouchEnd(event)">

                        <div class="chat-actions">
                            <button onclick="deleteChat('${friend.id}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                             <button onclick="showModal('–°–∫—Ä—ã—Ç—å —á–∞—Ç', '–ò–º–∏—Ç–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ ${friend.name} –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è.'); resetSwipedChat('${friend.id}')" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>
                                –°–∫—Ä—ã—Ç—å
                            </button>
                        </div>

                        <div class="chat-content p-3 flex items-center shadow rounded-xl"
                             onclick="handleChatClick('${friend.id}')">
                            
                            <div class="w-14 h-14 rounded-full flex items-center justify-center text-3xl 
                                        bg-gray-600 dark:bg-gray-600 flex-shrink-0 mr-3">
                                ${friend.avatar}
                            </div>
                            
                            <div class="flex-grow min-w-0">
                                <div class="flex justify-between items-start">
                                    <span class="text-lg font-semibold truncate">${friend.name}</span>
                                    ${unreadBadge}
                                </div>
                                <p class="text-sm text-gray-400 dark:text-gray-400 truncate mt-0.5">
                                    ${friend.lastMessage}
                                </p>
                            </div>
                            
                            <div class="ml-4 text-xs flex-shrink-0 text-right">
                                 <p class="${status.color}">${status.text === '–û–Ω–ª–∞–π–Ω' ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}</p>
                                 <p class="font-mono text-gray-500 dark:text-gray-500 mt-1">ID: ${friend.userId}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            contentElement.innerHTML = `<div class="p-2">${html}</div>`;
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å, –Ω–æ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–æ–¥–∞ ---

        window.getCurrentTheme = function() { return 'dark'; }

        function applyTheme(theme) {
            const body = document.body;
            const container = document.getElementById('app-container');
            const toggleClasses = (element, add, remove) => {
                element.classList.add(...add);
                element.classList.remove(...remove);
            };
            
            body.classList.add('dark');
            
            toggleClasses(body, ['bg-gray-900', 'text-white'], ['bg-white', 'text-gray-900']);
            toggleClasses(container, ['bg-gray-800', 'shadow-gray-700'], ['bg-white', 'shadow-blue-200']);
            
            const btnColorClass = ['bg-gray-700', 'text-white'];
            if(newChatBtn) toggleClasses(newChatBtn, btnColorClass, []);
            if(backBtn) toggleClasses(backBtn, btnColorClass, []);
            if(appBackBtn) toggleClasses(appBackBtn, btnColorClass, []);
        }

        function updateScreenState(screenName) {
            currentScreen = screenName;
            const isChatScreen = screenName === 'chatScreen';
            
            backBtn.classList.toggle('hidden', screenName === 'dialoguesList'); 
            newChatBtn.classList.toggle('hidden', isChatScreen); 
            appBackBtn.classList.toggle('hidden', isChatScreen); 
            chatInputContainer.classList.toggle('hidden', !isChatScreen); 
            searchContainer.classList.toggle('hidden', isChatScreen); 

            if (screenHistory[screenHistory.length - 1] !== screenName) {
                screenHistory.push(screenName);
            }
            if (isChatScreen) {
                 resetSwipedChat();
            }
        }
        
        window.goBack = function() {
            if (screenHistory.length > 1) {
                screenHistory.pop();
                const previousScreenName = screenHistory[screenHistory.length - 1];
                
                if (previousScreenName === 'dialoguesList') {
                    activeChat = null;
                    screenTransition(renderDialoguesList);
                    updateScreenState('dialoguesList');
                    updateHeader('–î–∏–∞–ª–æ–≥–∏', '–í–∞—à ID: ' + userData.uniqueId, 'üí¨');
                } else if (previousScreenName === 'chatScreen' && activeChat) {
                    screenTransition(() => renderChatScreen(activeChat.id));
                }
            } else {
                 showModal("–í—ã—Ö–æ–¥", "–ò–º–∏—Ç–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.");
            }
        }
        
        function updateHeader(title, status, avatar) {
            titleElement.textContent = title;
            chatStatus.textContent = status;
            chatHeaderAvatar.textContent = avatar;
            
            if (title === '–î–∏–∞–ª–æ–≥–∏') {
                 chatHeaderAvatar.classList.remove('bg-gray-500', 'dark:bg-gray-600');
                 chatHeaderAvatar.classList.add('bg-blue-500', 'dark:bg-blue-600');
            } else {
                 chatHeaderAvatar.classList.remove('bg-blue-500', 'dark:bg-blue-600');
                 chatHeaderAvatar.classList.add('bg-gray-500', 'dark:bg-gray-600');
            }
        }

        window.filterDialogues = function(query) {
            const normalizedQuery = query.toLowerCase().trim();
            const filteredData = MOCK_CHATS_DATA.filter(chat => {
                const nameMatch = chat.name.toLowerCase().includes(normalizedQuery);
                const idMatch = chat.userId.includes(normalizedQuery);
                return nameMatch || idMatch;
            });
            renderDialoguesList(filteredData);
        }

        window.openNewChatModal = function() {
            document.getElementById('target-user-id').value = '';
            const modal = document.getElementById('new-chat-modal');
            const card = document.getElementById('new-chat-modal-card');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            card.classList.remove('animate-out');
            card.classList.add('animate-in');
        }

        window.closeNewChatModal = function() {
            const modal = document.getElementById('new-chat-modal');
            const card = document.getElementById('new-chat-modal-card');
            card.classList.remove('animate-in');
            card.classList.add('animate-out');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                card.classList.remove('animate-out');
            }, 300);
        }

        window.startNewChat = function() {
            const targetId = document.getElementById('target-user-id').value.trim();
            
            if (!targetId || targetId === userData.uniqueId) {
                showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.');
                return;
            }

            let existingChat = MOCK_CHATS_DATA.find(chat => chat.userId === targetId);

            if (existingChat) {
                closeNewChatModal();
                screenTransition(() => renderChatScreen(existingChat.id));
                return;
            }

            const newChatId = 'chat_' + Date.now();
            const newFriendName = '–ù–æ–≤—ã–π –¥—Ä—É–≥ ' + targetId.slice(0, 3);
            const newAvatar = EMOJI_LIST[Math.floor(Math.random() * EMOJI_LIST.length)];

            const newChat = {
                id: newChatId, 
                userId: targetId, 
                name: newFriendName, 
                avatar: newAvatar, 
                lastMessage: '–ù–∞—á–Ω–∏—Ç–µ –≤–∞—à—É –ø–µ—Ä–µ–ø–∏—Å–∫—É!', 
                lastSeen: Date.now(), 
                unreadCount: 0 
            };
            
            MOCK_CHATS_DATA.unshift(newChat); 
            MOCK_MESSAGES[newChatId] = [];

            closeNewChatModal();
            screenTransition(() => renderChatScreen(newChatId));
            showModal('–£—Å–ø–µ—à–Ω–æ', `–ù–∞—á–∞—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å ID: ${targetId}`);
        }

        window.renderChatScreen = function(chatId) {
            activeChat = MOCK_CHATS_DATA.find(c => c.id === chatId);
            if (!activeChat) {
                showModal('–û—à–∏–±–∫–∞', '–î–∏–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                return;
            }
            
            activeChat.unreadCount = 0;

            const status = getLastSeenText(activeChat.lastSeen);
            updateHeader(activeChat.name, `ID: ${activeChat.userId} | ${status.text}`, activeChat.avatar);
            updateScreenState('chatScreen');

            const messages = MOCK_MESSAGES[chatId] || [];
            
            const messagesHtml = messages.map(msg => {
                const isSentByMe = msg.senderId === userData.uniqueId;
                const alignment = isSentByMe ? 'justify-end' : 'justify-start';
                const bgColor = isSentByMe ? 'bg-blue-600 text-white' : 'bg-gray-700 dark:bg-gray-700 text-white dark:text-white';
                const borderRadius = isSentByMe ? 'rounded-tl-xl rounded-bl-xl rounded-tr-sm rounded-br-xl' : 'rounded-tr-xl rounded-br-xl rounded-tl-sm rounded-bl-xl';
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="flex ${alignment} mb-3">
                        <div class="max-w-xs md:max-w-md">
                            <div class="p-3 ${bgColor} ${borderRadius} shadow-md break-words">
                                ${msg.text.replace(/\n/g, '<br>')}
                            </div>
                            <div class="text-xs mt-1 ${isSentByMe ? 'text-right text-gray-400 dark:text-gray-400' : 'text-left text-gray-400 dark:text-gray-400'}">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            contentElement.innerHTML = `<div id="messages-list" class="flex flex-col pt-2 pb-4">${messagesHtml}</div>`;
            
            setTimeout(() => {
                contentElement.scrollTop = contentElement.scrollHeight;
                messageInput.value = '';
                autoResizeTextarea(messageInput);
                checkInputForSend(messageInput);
            }, 50);
        }

        window.sendMessage = function() {
            const text = messageInput.value.trim();
            if (text === "" || !activeChat) return;

            const newMessage = {
                senderId: userData.uniqueId,
                text: text,
                timestamp: Date.now()
            };

            if (!MOCK_MESSAGES[activeChat.id]) {
                MOCK_MESSAGES[activeChat.id] = [];
            }
            MOCK_MESSAGES[activeChat.id].push(newMessage);
            
            const chatIndex = MOCK_CHATS_DATA.findIndex(c => c.id === activeChat.id);
            if (chatIndex !== -1) {
                MOCK_CHATS_DATA[chatIndex].lastMessage = text;
                MOCK_CHATS_DATA[chatIndex].lastSeen = newMessage.timestamp;
                MOCK_CHATS_DATA.unshift(MOCK_CHATS_DATA.splice(chatIndex, 1)[0]); 
            }

            renderChatScreen(activeChat.id);

            messageInput.value = '';
            autoResizeTextarea(messageInput);
            checkInputForSend(messageInput);
        }

        window.getLastSeenText = function(timestamp) {
            const lastSeen = new Date(timestamp);
            const diffMinutes = Math.floor((Date.now() - lastSeen) / 60000);

            if (diffMinutes < 5) return { text: '–û–Ω–ª–∞–π–Ω', color: 'text-green-500' };
            if (diffMinutes < 60) return { text: `–ë—ã–ª ${diffMinutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`, color: 'text-gray-400' };
            if (diffMinutes < 1440) return { text: `–ë—ã–ª ${Math.floor(diffMinutes / 60)} —á. –Ω–∞–∑–∞–¥`, color: 'text-gray-400' };
            
            return { text: lastSeen.toLocaleDateString(), color: 'text-gray-400' };
        };

        window.screenTransition = function(renderFunction) {
            contentElement.classList.add('screen-transition-out');
            setTimeout(() => {
                contentElement.classList.remove('screen-transition-out');
                contentElement.innerHTML = '';
                renderFunction();
                contentElement.classList.add('screen-transition-in');
                setTimeout(() => {
                    contentElement.classList.remove('screen-transition-in');
                }, 400);
            }, 400);
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const maxHeight = parseInt(getComputedStyle(textarea).lineHeight) * 3;
            if (textarea.scrollHeight > maxHeight) {
                textarea.style.overflowY = 'auto';
                textarea.style.height = maxHeight + 'px';
            } else {
                textarea.style.overflowY = 'hidden';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }
        
        window.checkInputForSend = function(input) {
            sendBtn.disabled = input.value.trim().length === 0;
            sendBtn.classList.toggle('opacity-50', sendBtn.disabled);
            sendBtn.classList.toggle('hover:scale-110', !sendBtn.disabled);
        }

        window.handleKeydown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (!sendBtn.disabled) {
                    sendMessage();
                }
            }
        }
        
        window.showModal = function(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'items-center', 'justify-center'); 
            document.querySelector('#modal > div').classList.remove('animate-out');
            document.querySelector('#modal > div').classList.add('animate-in');
            
            const extraBtn = document.querySelector('#modal button.bg-red-600');
            if (extraBtn) extraBtn.remove();
        }

        window.hideModal = function() {
            const modal = document.getElementById('modal');
            document.querySelector('#modal > div').classList.remove('animate-in');
            document.querySelector('#modal > div').classList.add('animate-out');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'items-center', 'justify-center');
            }, 300);
        }

        window.showEmojiSelectionModal = function() {
            const modal = document.getElementById('emoji-selection-modal');
            const card = document.getElementById('emoji-selection-card');
            const grid = document.getElementById('emoji-grid');
            
            const emojiHtml = EMOJI_LIST.map(emoji => `
                <button class="text-3xl hover:bg-gray-700 dark:hover:bg-gray-700 rounded-lg p-1 transition-colors"
                        onclick="insertEmoji('${emoji}'); closeEmojiSelectionModal()">
                    ${emoji}
                </button>
            `).join('');
            grid.innerHTML = emojiHtml;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            card.classList.remove('animate-out');
            card.classList.add('animate-in');
        }

        window.closeEmojiSelectionModal = function() {
            const modal = document.getElementById('emoji-selection-modal');
            const card = document.getElementById('emoji-selection-card');
            card.classList.remove('animate-in');
            card.classList.add('animate-out');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                card.classList.remove('animate-out');
            }, 300);
        }

        window.insertEmoji = function(emoji) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;

            input.value = value.substring(0, start) + emoji + value.substring(end);
            
            input.selectionStart = input.selectionEnd = start + emoji.length;
            
            autoResizeTextarea(input);
            checkInputForSend(input);
            input.focus();
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(getCurrentTheme()); 
            renderDialoguesList(); 
        });

    </script>
</body>
</html>